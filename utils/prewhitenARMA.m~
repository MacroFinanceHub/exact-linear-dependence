function [X_tilde,Y_tilde,W_tilde,orders] = prewhitenARMA(X,Y,W,p_max,q_max)
% Takes in two vectors, X and Y, (optionally a third, W) and outputs the
% pre-whitened time series (based on the ARMA(p,q) model of X)

% Get the model order
if nargin < 4 || isempty(p_max)
  p_max = 1;
end
if nargin < 5 || isempty(q_max)
  q_max = 1;
end

% Try two ARMA fitting procedures (if both fail then the try-catch outside should set this run to NaN)
logL = cell(p_max,q_max)
mdls = cell(p_max,q_max);
for p = 1:p
  
  for q = 1:q
    try
      [mdl,~,logL(p,q)] = estimate(mdl,X,'Display','off');
    catch
      opts = optimset('fmincon');
      opts.Algorithm = 'interior-point';
      mdl = estimate(mdl,X,'options',opts,'Display','off');
    end
  end
end


orders = [p_max,q_max];

X_tilde = infer(mdl,X);
Y_tilde = infer(mdl,Y);

if nargin > 2 || isempty(W)
  W_tilde = zeros(size(X_tilde,1),size(W,2));
  for i = 1:size(W,2)
    W_tilde(:,i) = infer(mdl,W(:,i));
  end
else
  W_tilde = [];
end